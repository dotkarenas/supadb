# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a data repository for managing VTuber information using JSON-based structured data. The repository contains metadata and member information for various VTuber groups, which can be synced to a Supabase database.

## Setup

### Install Dependencies
```bash
npm install
```

### Environment Variables

Copy `.env.sample` to create your environment files:
```bash
# For development
cp .env.sample .env.local

# For production
cp .env.sample .env.production
```

Then fill in the following values:
```bash
NEXT_PUBLIC_SUPABASE_URL=your_supabase_project_url
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key
YOUTUBE_API_KEY=your_youtube_api_key
```

## Commands

### Update Metadata
```bash
npm run update-metadata
```
Automatically generates/updates metadata files based on directory structure:
- **`data/jobs.json`**: List of all job categories (e.g., VTuber, AVTuber)
- **`data/{job_name}/groups.json`**: List of groups within each job category

**Behavior**:
- Scans all directories under `data/` to detect jobs and groups
- Extracts `metadata.group` and `metadata.source` from each `members.json`
- Preserves existing group entries that don't have `members.json` yet
- Run this before committing changes to keep metadata in sync

### Update Master
```bash
npm run update-master
```
Generates a consolidated master file containing all member data:
- **`data/master.json`**: Flattened list of all members across all jobs and groups

**Behavior**:
- Scans all `members.json` files across all job and group directories
- Converts hierarchical data structure into flat member records
- Each record includes: `job`, `group`, `name`, `youtube_id`, and `options` (if present)
- Useful for bulk operations, data analysis, and external integrations

### Validation
```bash
npm run validate -- data/VTuber/{group_name}/members.json
```
Validates a members.json file against the JSON schema using AJV.

### Sync Data to Supabase

**Development (Local Supabase)**
```bash
npm run sync-data:development
```

**Production**
```bash
npm run sync-data:production
```

Automatically syncs all VTuber data to Supabase:
- Detects all `members.json` files across all job and group directories
- Creates threads in the `threads` table with YouTube channel info and avatars
- Updates existing threads if data has changed (name, YouTube title, tags)
- Skips members with empty `youtube_id` (no YouTube channel)
- Uploads channel thumbnails to Supabase Storage (`threads` bucket)
- Associates tags (job, group, options) with threads via `thread_tags` table
- Uses YouTube Data API v3 to fetch channel metadata
- Includes rate limiting (100ms delay between API calls)
- Displays progress per group and overall summary

## Architecture

### Data Layer
- `data/schema.json`: JSON Schema defining the structure for all member data files
- `data/members.template.jsonc`: Template for creating new group data files
- `data/jobs.json`: List of job categories (auto-generated by `update-metadata`)
- `data/{job_name}/groups.json`: List of groups per job (auto-generated by `update-metadata`)
- `data/{job_name}/{group_name}/members.json`: Per-group member data files
- `data/master.json`: Consolidated flat list of all members (auto-generated by `update-master`)

**Metadata Files Structure**:
- `jobs.json`: Contains array of job objects with `name` field
- `groups.json`: Contains array of group objects with:
  - `name`: Group display name (from `members.json` metadata)
  - `source`: Official website URL (nullable)
- `master.json`: Contains array of member objects with:
  - `job`: Job category (e.g., "VTuber", "AVTuber")
  - `group`: Group name (e.g., "ホロライブ")
  - `name`: Member name
  - `youtube_id`: YouTube channel ID or handle
  - `options`: Optional tags (array, only included if present)

### Supabase Integration
The `sync-data.ts` script integrates with Supabase:
- **Database Tables**:
  - `threads`: Stores VTuber info (id, name, youtube_id, youtube_title, avatar_path)
  - `tags`: Tag definitions (id, name)
  - `thread_tags`: Many-to-many relationship (thread_id, tag_id)
- **Storage**: `threads` bucket stores channel avatars at path `{thread_id}/avatar/{timestamp}.jpg`
- **Authentication**: Uses service role key to bypass RLS

### Tag System
Tags are automatically created from:
1. `metadata.job` (e.g., "VTuber")
2. `metadata.group` (e.g., "ホロライブ")
3. `member.options` (e.g., ["ホロライブ 0期生"])

When syncing existing threads, the script compares current tags with expected tags from members.json and updates accordingly.

## Environment Variables

Required in `.env.local` (development) and `.env.production` (production):
- `NEXT_PUBLIC_SUPABASE_URL`: Supabase project URL
- `SUPABASE_SERVICE_ROLE_KEY`: Service role key for admin operations
- `YOUTUBE_API_KEY`: YouTube Data API v3 key

## Data Structure

Each `members.json` follows this schema:
```json
{
  "metadata": {
    "job": "VTuber",
    "group": "Group Name",
    "options": ["Optional tags"],
    "source": "Official website URL"
  },
  "members": [
    {
      "name": "VTuber Name",
      "youtube_id": "UC... or @handle",
      "options": ["Member-specific tags"]
    }
  ]
}
```

### YouTube ID Formats
- Channel ID: `UCxxxxxxxxxxxxxxxxxxx` (22 characters after UC)
- Handle: `@username`

## Validation Rules

- `youtube_id` must match: `^(UC[a-zA-Z0-9_-]{22}|@[a-zA-Z0-9_-]+)?$` (can be empty string)
- Required fields: `metadata.job`, `metadata.group`, `member.name`, `member.youtube_id`
- Optional fields: `metadata.options`, `metadata.source`, `member.options`

### YouTube Channel Handling
- **Members with `youtube_id`**: Will be synced to Supabase with channel info and avatar
- **Members with empty `youtube_id` (`""`)**:  Will be skipped during sync (no YouTube channel exists or not yet discovered)

## Working with Data

### Workflow for Adding New Groups

#### 1. Plan: Add to groups.json (Optional)
Before collecting member data, you can add the group to `groups.json`:
```json
{
  "name": "New Group Name",
  "source": "https://example.com"
}
```
This helps track which groups you plan to collect.

#### 2. Collect: Create members.json
1. Create directory: `data/{job_name}/{group_name}/`
2. Copy `data/members.template.jsonc` as starting point
3. Fill in metadata and members
4. Validate: `npm run validate -- data/{job_name}/{group_name}/members.json`

#### 3. Update Metadata (Required)
```bash
npm run update-metadata
```
This automatically:
- Updates `jobs.json` with all job categories
- Updates `groups.json` with the new group
- Preserves any existing entries you added manually

**IMPORTANT:** This command must be run before committing changes. CI will verify that metadata files are up-to-date.

#### 4. Generate Master File (Required)
```bash
npm run update-master
```
This generates a consolidated `master.json` containing all members. Useful for:
- Quick access to all member data in a flat structure
- Data analysis and reporting
- External integrations

**IMPORTANT:** This command must be run before committing changes. CI will verify that master.json is up-to-date.

#### 5. Commit Changes
Commit all changes including generated files:
- `data/jobs.json`
- `data/{job_name}/groups.json`
- `data/master.json`
- `data/{job_name}/{group_name}/members.json`

#### 6. Sync to Supabase
- Development: `npm run sync-data:development`
- Production: `npm run sync-data:production`

### Updating Existing Data
1. Edit `data/VTuber/{group_name}/members.json`
2. Validate changes against schema
3. Re-run sync-data to sync updates (script handles updates automatically)

### Sync Behavior
The sync-data script is idempotent:
- Creates new threads for new members
- Updates existing threads if name, YouTube title, or tags changed
- Skips unchanged threads
- Reports summary (success/skipped/failed counts)

## Troubleshooting

### YouTube API Quota
- The script includes 100ms delay between API calls to avoid quota issues
- If you hit quota limits, wait or apply for increased quota
- Channel ID format: `UCxxxxxxxxxxxxxxxxxxx` (22 chars after UC)
- Handle format: `@username`

### Common Validation Errors
- `youtube_id` must match pattern: `^(UC[a-zA-Z0-9_-]{22}|@[a-zA-Z0-9_-]+)$`
- Required fields: `metadata.job`, `metadata.group`, `member.name`, `member.youtube_id`
- Optional fields can be `null` or array of strings
