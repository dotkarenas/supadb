# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a data repository for managing VTuber information using JSON-based structured data. The repository contains metadata and member information for various VTuber groups, which can be synced to a Supabase database.

## Setup

### Install Dependencies
```bash
npm install
```

### Environment Variables

Copy `.env.sample` to create your environment files:
```bash
# For development
cp .env.sample .env.local

# For production
cp .env.sample .env.production
```

Then fill in the following values:
```bash
NEXT_PUBLIC_SUPABASE_URL=your_supabase_project_url
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key
YOUTUBE_API_KEY=your_youtube_api_key
```

## Commands

### Update Metadata
```bash
npm run update-metadata
```
Automatically generates/updates metadata files based on directory structure:
- **`data/jobs.json`**: List of all job categories (e.g., VTuber, AVTuber)
- **`data/{job_name}/groups.json`**: List of groups within each job category

**Behavior**:
- Scans all directories under `data/` to detect jobs and groups
- Extracts `metadata.group` and `metadata.source` from each `members.json`
- Sets `status: "completed"` for groups with existing `members.json`
- Preserves `status: "pending"` entries for groups planned but not yet collected
- Run this before committing changes to keep metadata in sync

### Validation
```bash
npm run validate -- data/VTuber/{group_name}/members.json
```
Validates a members.json file against the JSON schema using AJV.

### Bulk Thread Creation

**Development (Local Supabase)**
```bash
npm run bulk-create:development data/VTuber/{group_name}/members.json
```

**Production**
```bash
npm run bulk-create:production data/VTuber/{group_name}/members.json
```

Syncs VTuber data to Supabase:
- Creates threads in the `threads` table with YouTube channel info and avatars
- Updates existing threads if data has changed (name, YouTube title, tags)
- Skips members with empty `youtube_id` (no YouTube channel)
- Uploads channel thumbnails to Supabase Storage (`threads` bucket)
- Associates tags (job, group, options) with threads via `thread_tags` table
- Uses YouTube Data API v3 to fetch channel metadata
- Includes rate limiting (100ms delay between API calls)

## Architecture

### Data Layer
- `data/schema.json`: JSON Schema defining the structure for all VTuber data
- `data/members.template.jsonc`: Template for creating new group data files
- `data/jobs.json`: List of job categories (auto-generated by `update-metadata`)
- `data/{job_name}/groups.json`: List of groups per job (auto-generated by `update-metadata`)
- `data/{job_name}/{group_name}/members.json`: Per-group VTuber member data files

**Metadata Files Structure**:
- `jobs.json`: Contains array of job objects with `name` field
- `groups.json`: Contains array of group objects with:
  - `name`: Group display name (from `members.json` metadata)
  - `source`: Official website URL (nullable)
  - `status`: Either `"pending"` (planned) or `"completed"` (has `members.json`)

### Supabase Integration
The `bulk-create-threads.ts` script integrates with Supabase:
- **Database Tables**:
  - `threads`: Stores VTuber info (id, name, youtube_id, youtube_title, avatar_path)
  - `tags`: Tag definitions (id, name)
  - `thread_tags`: Many-to-many relationship (thread_id, tag_id)
- **Storage**: `threads` bucket stores channel avatars at path `{thread_id}/avatar/{timestamp}.jpg`
- **Authentication**: Uses service role key to bypass RLS

### Tag System
Tags are automatically created from:
1. `metadata.job` (e.g., "VTuber")
2. `metadata.group` (e.g., "ホロライブ")
3. `member.options` (e.g., ["ホロライブ 0期生"])

When syncing existing threads, the script compares current tags with expected tags from members.json and updates accordingly.

## Environment Variables

Required in `.env.local` (development) and `.env.production` (production):
- `NEXT_PUBLIC_SUPABASE_URL`: Supabase project URL
- `SUPABASE_SERVICE_ROLE_KEY`: Service role key for admin operations
- `YOUTUBE_API_KEY`: YouTube Data API v3 key

## Data Structure

Each `members.json` follows this schema:
```json
{
  "metadata": {
    "job": "VTuber",
    "group": "Group Name",
    "options": ["Optional tags"],
    "source": "Official website URL"
  },
  "members": [
    {
      "name": "VTuber Name",
      "youtube_id": "UC... or @handle",
      "options": ["Member-specific tags"]
    }
  ]
}
```

### YouTube ID Formats
- Channel ID: `UCxxxxxxxxxxxxxxxxxxx` (22 characters after UC)
- Handle: `@username`

## Validation Rules

- `youtube_id` must match: `^(UC[a-zA-Z0-9_-]{22}|@[a-zA-Z0-9_-]+)?$` (can be empty string)
- Required fields: `metadata.job`, `metadata.group`, `member.name`, `member.youtube_id`
- Optional fields: `metadata.options`, `metadata.source`, `member.options`

### YouTube Channel Handling
- **Members with `youtube_id`**: Will be synced to Supabase with channel info and avatar
- **Members with empty `youtube_id` (`""`)**:  Will be skipped during sync (no YouTube channel exists or not yet discovered)

## Working with Data

### Workflow for Adding New Groups

#### 1. Plan: Add to groups.json (Optional but Recommended)
Before collecting member data, you can add the group to `groups.json` with `status: "pending"`:
```json
{
  "name": "New Group Name",
  "source": "https://example.com",
  "status": "pending"
}
```
This helps track which groups you plan to collect.

#### 2. Collect: Create members.json
1. Create directory: `data/{job_name}/{group_name}/`
2. Copy `data/members.template.jsonc` as starting point
3. Fill in metadata and members
4. Validate: `npm run validate -- data/{job_name}/{group_name}/members.json`

#### 3. Update Metadata
```bash
npm run update-metadata
```
This automatically:
- Updates `groups.json` with the new group (sets `status: "completed"`)
- Preserves any `pending` entries you added manually

#### 4. Sync to Supabase
- Development: `npm run bulk-create:development data/{job_name}/{group_name}/members.json`
- Production: `npm run bulk-create:production data/{job_name}/{group_name}/members.json`

### Updating Existing Data
1. Edit `data/VTuber/{group_name}/members.json`
2. Validate changes against schema
3. Re-run bulk-create to sync updates (script handles updates automatically)

### Sync Behavior
The bulk-create script is idempotent:
- Creates new threads for new members
- Updates existing threads if name, YouTube title, or tags changed
- Skips unchanged threads
- Reports summary (success/skipped/failed counts)

## Troubleshooting

### YouTube API Quota
- The script includes 100ms delay between API calls to avoid quota issues
- If you hit quota limits, wait or apply for increased quota
- Channel ID format: `UCxxxxxxxxxxxxxxxxxxx` (22 chars after UC)
- Handle format: `@username`

### Common Validation Errors
- `youtube_id` must match pattern: `^(UC[a-zA-Z0-9_-]{22}|@[a-zA-Z0-9_-]+)$`
- Required fields: `metadata.job`, `metadata.group`, `member.name`, `member.youtube_id`
- Optional fields can be `null` or array of strings
